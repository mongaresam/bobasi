{% extends 'finance/base.html' %}
{% block title %}Disburse Funds â€” Bobasi BBS{% endblock %}
{% block page_title %}Disburse Bursary Funds{% endblock %}
{% block content %}

<div style="max-width:820px;">
  {% if not approved_apps %}
  <div class="card">
    <div style="padding:60px;text-align:center;">
      <div style="font-size:56px;margin-bottom:16px;">â³</div>
      <h3 style="font-family:'Playfair Display',serif;font-size:22px;color:#1e3c72;margin-bottom:8px;">No Applications Ready for Disbursement</h3>
      <p style="color:#64748b;margin-bottom:24px;">Applications must be approved by the committee before funds can be disbursed.</p>
      <a href="{{ url_for('admin.applications') }}?status=approved" class="btn btn-primary">View Approved Applications</a>
    </div>
  </div>
  {% else %}

  <div class="card">
    <div class="card-header">
      <h3>ğŸ’¸ Process Bursary Disbursement</h3>
      <span class="badge badge-pending">{{ approved_apps|length }} awaiting disbursement</span>
    </div>
    <div style="padding:32px;">
      <form method="POST" action="{{ url_for('finance.disburse') }}" id="disbForm">

        <!-- Application selection -->
        <div class="form-group">
          <label>Select Approved Application *</label>
          <select name="application_id" id="appSelect" required onchange="loadAppDetails(this.value)">
            <option value="">â€” Choose an application â€”</option>
            {% for app in approved_apps %}
            <option value="{{ app.id }}"
              data-name="{{ app.student.full_name }}"
              data-institution="{{ app.student.institution or '' }}"
              data-course="{{ app.student.course or '' }}"
              data-level="{{ app.student.level_of_study or '' }}"
              data-amount="{{ app.approved_amount or app.requested_amount }}"
              data-bank="{{ app.student.bank_ac_no or '' }}"
              data-branch="{{ app.student.bank_branch or '' }}"
              data-account="{{ app.student.account_name or '' }}"
              data-phone="{{ app.student.phone or '' }}"
            >
              {{ app.application_number }} â€” {{ app.student.full_name }} ({{ app.student.institution or 'No institution' }})
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Auto-filled student details card -->
        <div id="studentDetails" style="display:none;background:#e8f1ff;border:1px solid #bfdbfe;border-radius:12px;padding:20px;margin-bottom:24px;">
          <h4 style="font-size:14px;font-weight:800;color:#1e3c72;margin-bottom:14px;">ğŸ“‹ Selected Student Details</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;">
            <div><span style="color:#64748b;">Full Name:</span> <strong id="det-name">â€”</strong></div>
            <div><span style="color:#64748b;">Institution:</span> <strong id="det-institution">â€”</strong></div>
            <div><span style="color:#64748b;">Course:</span> <strong id="det-course">â€”</strong></div>
            <div><span style="color:#64748b;">Level:</span> <strong id="det-level">â€”</strong></div>
            <div><span style="color:#64748b;">Phone:</span> <strong id="det-phone">â€”</strong></div>
            <div><span style="color:#64748b;">Bank A/C:</span> <strong id="det-bank">â€”</strong></div>
          </div>
          <div style="margin-top:12px;padding:12px;background:rgba(30,60,114,0.08);border-radius:8px;font-size:13px;">
            <span style="color:#64748b;">Approved Amount:</span>
            <strong id="det-amount" style="color:#1e3c72;font-family:'Playfair Display',serif;font-size:18px;">â€”</strong>
          </div>
        </div>

        <!-- Amount and method -->
        <div class="form-row">
          <div class="form-group">
            <label>Amount to Disburse (KShs) *</label>
            <input type="number" name="amount" id="amountField" step="0.01" min="1" required placeholder="Enter amount in KShs">
          </div>
          <div class="form-group">
            <label>Payment Method *</label>
            <select name="payment_method" id="payMethod" required onchange="toggleBankFields(this.value)">
              <option value="">â€” Select method â€”</option>
              <option value="bank_transfer">ğŸ¦ Bank Transfer</option>
              <option value="mpesa">ğŸ“± M-Pesa</option>
              <option value="cheque">ğŸ“„ Cheque</option>
              <option value="cash">ğŸ’µ Cash</option>
            </select>
          </div>
        </div>

        <!-- Bank details (shown conditionally) -->
        <div id="bankFields" style="display:none;">
          <div class="form-row">
            <div class="form-group">
              <label>Bank Name</label>
              <input type="text" name="bank_name" id="bankName" placeholder="e.g. Equity Bank">
            </div>
            <div class="form-group">
              <label>Account Number</label>
              <input type="text" name="account_number" id="accountNum" placeholder="Bank account number">
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label>Notes / Remarks</label>
          <textarea name="notes" rows="3" placeholder="Optional: Add any notes about this disbursementâ€¦" style="resize:vertical;"></textarea>
        </div>

        <!-- Confirmation checkbox -->
        <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:10px;padding:16px;margin-bottom:24px;">
          <label style="display:flex;align-items:flex-start;gap:12px;cursor:pointer;font-size:14px;">
            <input type="checkbox" id="confirmCheck" style="width:auto;margin-top:2px;" required>
            <span>I confirm that this disbursement has been authorised and the details above are accurate. This action <strong>cannot be undone</strong>.</span>
          </label>
        </div>

        <div style="display:flex;gap:12px;">
          <button type="submit" class="btn btn-primary">ğŸ’¸ Process Disbursement</button>
          <a href="{{ url_for('finance.dashboard') }}" class="btn btn-outline">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
function loadAppDetails(appId) {
  const select = document.getElementById('appSelect');
  const opt = select.options[select.selectedIndex];
  const det = document.getElementById('studentDetails');

  if (!appId) { det.style.display = 'none'; return; }

  det.style.display = 'block';
  document.getElementById('det-name').textContent = opt.dataset.name || 'â€”';
  document.getElementById('det-institution').textContent = opt.dataset.institution || 'â€”';
  document.getElementById('det-course').textContent = opt.dataset.course || 'â€”';
  document.getElementById('det-level').textContent = opt.dataset.level || 'â€”';
  document.getElementById('det-phone').textContent = opt.dataset.phone || 'â€”';
  document.getElementById('det-bank').textContent = opt.dataset.bank || 'â€”';
  const amt = parseFloat(opt.dataset.amount) || 0;
  document.getElementById('det-amount').textContent = 'KShs ' + amt.toLocaleString('en-KE', {minimumFractionDigits:0});
  document.getElementById('amountField').value = amt > 0 ? amt : '';

  // Pre-fill bank details
  if (opt.dataset.bank) {
    document.getElementById('bankName').value = opt.dataset.branch || '';
    document.getElementById('accountNum').value = opt.dataset.bank || '';
  }
}

function toggleBankFields(method) {
  const bf = document.getElementById('bankFields');
  bf.style.display = (method === 'bank_transfer' || method === 'cheque') ? 'block' : 'none';
}
</script>
{% endblock %}
