{% extends 'finance/base.html' %}
{% block title %}Disbursements — Bobasi BBS{% endblock %}
{% block page_title %}Disbursement Records{% endblock %}
{% block content %}

<div class="card">
  <div class="card-header">
    <h3>All Disbursements
      {% if method_filter %}<span class="badge badge-blue ml">{{ method_filter.replace('_',' ').title() }}</span>{% endif %}
    </h3>
    <div class="header-actions">
      <form method="GET" class="search-form">
        <input type="text" name="search" value="{{ search }}" placeholder="Search student or reference…" class="search-input" style="min-width:220px;">
        <select name="method" class="search-input" style="width:160px;">
          <option value="">All Methods</option>
          <option value="bank_transfer" {% if method_filter=='bank_transfer' %}selected{% endif %}>Bank Transfer</option>
          <option value="mpesa" {% if method_filter=='mpesa' %}selected{% endif %}>M-Pesa</option>
          <option value="cheque" {% if method_filter=='cheque' %}selected{% endif %}>Cheque</option>
        </select>
        <button type="submit" class="btn btn-primary btn-sm">Filter</button>
        {% if search or method_filter %}<a href="{{ url_for('finance.disbursements') }}" class="btn btn-sm btn-outline">Clear</a>{% endif %}
      </form>
    </div>
  </div>

  <div class="table-wrap">
    <table class="admin-table">
      <thead>
        <tr><th>#</th><th>Reference</th><th>Student</th><th>Institution</th><th>Amount</th><th>Method</th><th>Bank / Account</th><th>Officer</th><th>Date</th></tr>
      </thead>
      <tbody>
        {% for d in disbursements %}
        <tr>
          <td style="color:#94a3b8;font-size:12px;">{{ loop.index }}</td>
          <td><span class="sn-tag">{{ d.reference_number }}</span></td>
          <td><strong>{{ d.student.full_name }}</strong></td>
          <td style="font-size:13px;color:#64748b;">{{ d.student.institution or '—' }}</td>
          <td style="font-family:'Playfair Display',serif;font-weight:700;color:#1e3c72;">KShs {{ "{:,.0f}".format(d.amount) }}</td>
          <td>
            <span class="badge badge-{% if d.payment_method == 'bank_transfer' %}approved{% elif d.payment_method == 'mpesa' %}under_review{% else %}pending{% endif %}">
              {{ d.payment_method.replace('_',' ').title() }}
            </span>
          </td>
          <td style="font-size:12px;color:#64748b;">
            {% if d.bank_name %}{{ d.bank_name }}{% if d.account_number %} · {{ d.account_number }}{% endif %}{% else %}—{% endif %}
          </td>
          <td style="font-size:12px;color:#64748b;">{{ d.finance_officer.name if d.finance_officer else '—' }}</td>
          <td style="font-size:12px;color:#64748b;">{{ d.disbursement_date.strftime('%d %b %Y') }}</td>
        </tr>
        {% else %}
        <tr><td colspan="9" class="no-data">No disbursements found.</td></tr>
        {% endfor %}
      </tbody>
      {% if disbursements %}
      <tfoot>
        <tr class="total-row">
          <td colspan="4"><strong>GRAND TOTAL</strong></td>
          <td style="font-family:'Playfair Display',serif;font-weight:900;color:#1e3c72;font-size:15px;">KShs {{ "{:,.0f}".format(total) }}</td>
          <td colspan="4"></td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>
  <div class="table-footer">
    Showing <strong>{{ disbursements|length }}</strong> disbursements &mdash; Total: <strong style="color:#1e3c72;">KShs {{ "{:,.0f}".format(total) }}</strong>
  </div>
</div>
{% endblock %}
