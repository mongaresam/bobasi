{% extends 'base.html' %}
{% block title %}Student Dashboard â€” Bobasi BBS{% endblock %}
{% block content %}
<div class="portal-page">

  <!-- HEADER -->
  <div class="portal-header">
    <div class="portal-welcome">
      <h1>Welcome back, {{ student.full_name.split()[0] }}!</h1>
      <p>Bobasi NG-CDF Bursary Portal &mdash; 2025/2026 Financial Year</p>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <a href="{{ url_for('student.profile') }}" class="btn btn-outline btn-sm">âœï¸ Edit Profile</a>
      <a href="{{ url_for('application.apply') }}" class="btn btn-primary">+ New Application</a>
    </div>
  </div>

  {% if not student.profile_complete %}
  <div class="alert-banner">
    âš ï¸ Your profile is incomplete. <a href="{{ url_for('student.profile') }}">Complete your profile</a> to be eligible for bursary application.
  </div>
  {% endif %}

  <!-- STAT CARDS -->
  <div class="portal-stats">
    <div class="pstat-card">
      <div class="pstat-icon">ğŸ“</div>
      <div class="pstat-num">{{ status_counts.pending + status_counts.under_review }}</div>
      <div class="pstat-label">In Progress</div>
    </div>
    <div class="pstat-card green">
      <div class="pstat-icon">âœ…</div>
      <div class="pstat-num">{{ status_counts.approved + status_counts.disbursed }}</div>
      <div class="pstat-label">Approved / Disbursed</div>
    </div>
    <div class="pstat-card blue">
      <div class="pstat-icon">ğŸ’°</div>
      <div class="pstat-num" style="font-size:20px;">KShs {{ "{:,.0f}".format(total_received) }}</div>
      <div class="pstat-label">Total Received</div>
    </div>
    <div class="pstat-card amber">
      <div class="pstat-icon">âŒ</div>
      <div class="pstat-num">{{ status_counts.rejected }}</div>
      <div class="pstat-label">Rejected</div>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="portal-grid">
    <!-- Applications table -->
    <div class="pcard">
      <div class="pcard-header">
        <h3>ğŸ“‹ Recent Applications</h3>
        <a href="{{ url_for('student.my_applications') }}">View All â†’</a>
      </div>
      {% if apps %}
      <table class="portal-table">
        <thead>
          <tr><th>Reference</th><th>Academic Year</th><th>Amount Req.</th><th>Approved</th><th>Status</th><th>Date</th><th></th></tr>
        </thead>
        <tbody>
          {% for a in apps %}
          <tr>
            <td><span class="sn-tag">{{ a.application_number }}</span></td>
            <td>{{ a.academic_year }}</td>
            <td>KShs {{ "{:,.0f}".format(a.requested_amount) }}</td>
            <td>{% if a.approved_amount %}<strong style="color:#10b981;">KShs {{ "{:,.0f}".format(a.approved_amount) }}</strong>{% else %}<span style="color:#94a3b8;">â€”</span>{% endif %}</td>
            <td>
              <span class="badge badge-{{ a.status }}">{{ a.status.replace('_',' ').title() }}</span>
            </td>
            <td style="color:#64748b;font-size:13px;">{{ a.submitted_at.strftime('%d %b %Y') }}</td>
            <td><a href="{{ url_for('application.view', app_id=a.id) }}" class="btn-xs">View</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="empty-state">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ“</div>
        <p>You haven't submitted any applications yet.</p>
        {% if student.profile_complete %}
        <a href="{{ url_for('application.apply') }}" class="btn btn-primary btn-sm">Apply for Bursary</a>
        {% else %}
        <a href="{{ url_for('student.profile') }}" class="btn btn-primary btn-sm">Complete Profile First</a>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Right panel -->
    <div style="display:flex;flex-direction:column;gap:20px;">

      <!-- Profile completion card -->
      <div class="pcard">
        <div class="pcard-header"><h3>ğŸ‘¤ Profile Status</h3></div>
        <div style="padding:20px 24px;">
          {% set fields_done = [
            student.admission_number, student.institution, student.course,
            student.phone, student.id_number, student.sub_county,
            student.family_status, student.bank_ac_no
          ] %}
          {% set filled = fields_done | select | list | length %}
          {% set pct = (filled / 8 * 100) | round(0) | int %}
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px;">
            <span style="font-weight:700;color:#1e293b;">Completion</span>
            <span style="font-weight:800;color:{% if pct >= 80 %}#10b981{% elif pct >= 50 %}#f59e0b{% else %}#ef4444{% endif %};">{{ pct }}%</span>
          </div>
          <div style="background:#e2e8f0;border-radius:20px;height:8px;margin-bottom:16px;">
            <div style="width:{{ pct }}%;height:100%;border-radius:20px;background:linear-gradient(90deg,#1e3c72,#10b981);transition:width 1s ease;"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;">
            <div style="display:flex;align-items:center;gap:6px;color:{% if student.institution %}#10b981{% else %}#ef4444{% endif %};">
              {{ 'âœ…' if student.institution else 'â­•' }} Institution
            </div>
            <div style="display:flex;align-items:center;gap:6px;color:{% if student.phone %}#10b981{% else %}#ef4444{% endif %};">
              {{ 'âœ…' if student.phone else 'â­•' }} Phone
            </div>
            <div style="display:flex;align-items:center;gap:6px;color:{% if student.id_number %}#10b981{% else %}#ef4444{% endif %};">
              {{ 'âœ…' if student.id_number else 'â­•' }} ID Number
            </div>
            <div style="display:flex;align-items:center;gap:6px;color:{% if student.bank_ac_no %}#10b981{% else %}#ef4444{% endif %};">
              {{ 'âœ…' if student.bank_ac_no else 'â­•' }} Bank Account
            </div>
            <div style="display:flex;align-items:center;gap:6px;color:{% if student.sub_county %}#10b981{% else %}#ef4444{% endif %};">
              {{ 'âœ…' if student.sub_county else 'â­•' }} Sub-County
            </div>
            <div style="display:flex;align-items:center;gap:6px;color:{% if student.family_status %}#10b981{% else %}#ef4444{% endif %};">
              {{ 'âœ…' if student.family_status else 'â­•' }} Family Status
            </div>
          </div>
          <a href="{{ url_for('student.profile') }}" class="btn btn-primary full" style="margin-top:16px;">
            {{ 'Update Profile' if pct == 100 else 'Complete Profile' }}
          </a>
        </div>
      </div>

      <!-- Disbursements summary -->
      <div class="pcard">
        <div class="pcard-header">
          <h3>ğŸ’° Bursary Grants</h3>
          <a href="{{ url_for('student.my_disbursements') }}">View All â†’</a>
        </div>
        {% if disbursements %}
          {% for grant in disbursements[:3] %}
          <div style="padding:14px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:700;font-size:14px;color:#1e293b;">KShs {{ "{:,.0f}".format(grant.principal_amount) }}</div>
              <div style="font-size:12px;color:#64748b;">{{ grant.created_at.strftime('%d %b %Y') if grant.created_at else 'â€”' }}</div>
            </div>
            <span class="badge badge-approved">Disbursed</span>
          </div>
          {% endfor %}
          <div style="padding:14px 24px;background:#f8fafc;text-align:center;">
            <strong style="color:#1e3c72;font-family:'Playfair Display',serif;font-size:18px;">KShs {{ "{:,.0f}".format(total_received) }}</strong>
            <div style="font-size:11px;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px;">Total Bursary Received</div>
          </div>
        {% else %}
        <div class="empty-state" style="padding:32px 20px;">
          <p style="font-size:13px;">No bursary grants received yet.</p>
        </div>
        {% endif %}
      </div>

    </div>
  </div>

  <!-- NOTIFICATIONS -->
  {% if notifications %}
  <div class="pcard mt" style="margin-top:20px;">
    <div class="pcard-header">
      <h3>ğŸ”” Recent Notifications <span class="badge badge-pending" style="font-size:11px;">{{ notifications|length }} unread</span></h3>
      <a href="{{ url_for('student.notifications') }}">View All â†’</a>
    </div>
    {% for n in notifications %}
    <div class="notif-item">
      <div class="notif-title">{{ n.title }}</div>
      <div class="notif-msg">{{ n.message }}</div>
      <div class="notif-time">{{ n.created_at.strftime('%d %b %Y at %H:%M') }}</div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

</div>
{% endblock %}
